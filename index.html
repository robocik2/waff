<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Turntable Player</title>
  <style>
    body { display: flex; justify-content: center; align-items: center; height: 100vh; background: #222; color: white; margin: 0; }
    #controls { display: flex; gap: 50px; align-items: flex-end; }

    /* Turntable control */
    #turntable {
      width: 200px;
      height: 200px;
      border: 4px solid #888;
      border-radius: 50%;
      background: #444;
      cursor: pointer;
      position: relative;
      transform: rotate(0rad);
    }
    #turntable::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 10px;
      height: 10px;
      background: #222;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }

    /* Pitch/LFO control wrapper */
    #pitchWrapper { width: 100px; height: 200px; position: relative; }
    #anchorBottom, #anchorTop {
      width: 20px;
      height: 20px;
      background: #777;
      border-radius: 50%;
      position: absolute;
      left: calc(50% - 10px);
      cursor: grab;
    }
    #anchorBottom { bottom: 0; }
    #anchorTop { bottom: 50px; /* initial */ }

    /* Trunk as an image; initial height = 50px */
    #trunk {
      position: absolute;
      bottom: 0;
      left: calc(50% - 2px);
      width: 4px;
      height: 50px;
      transform-origin: bottom center;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="controls">
    <div id="turntable"></div>
    <div id="pitchWrapper">
      <!-- Replace 'trunk.png' with your image path -->
      <img id="trunk" src="trunk.png" alt="trunk" />
      <div id="anchorBottom"></div>
      <div id="anchorTop"></div>
    </div>
  </div>

  <audio id="audio" src="pykpykpyk.mp3" loop></audio>

  <script>
    // Turntable functionality (unchanged)
    const turntable = document.getElementById('turntable');
    const audio = document.getElementById('audio');
    let angle = 0, vel = 0, dragging = false, lastT = 0;
    let startAngle = 0, startPtr = 0, anim;
    function ptrAngle(e) {
      const r = turntable.getBoundingClientRect();
      const x = e.clientX - (r.left + r.width / 2);
      const y = e.clientY - (r.top + r.height / 2);
      return Math.atan2(y, x);
    }
    turntable.addEventListener('mousedown', e => {
      e.preventDefault(); dragging = true;
      startPtr = ptrAngle(e); startAngle = angle;
      lastT = performance.now(); cancelAnimationFrame(anim);
    });
    document.addEventListener('mousemove', e => {
      if (!dragging) return;
      const p = ptrAngle(e);
      const delta = p - startPtr;
      const now = performance.now();
      const dt = (now - lastT) / 1000;
      vel = (startAngle + delta - angle) / dt;
      angle = startAngle + delta; lastT = now;
      turntable.style.transform = `rotate(${angle}rad)`;
    });
    document.addEventListener('mouseup', () => {
      if (!dragging) return;
      dragging = false; lastT = performance.now();
      function inert() {
        const now = performance.now();
        const dt = (now - lastT) / 1000;
        lastT = now;
        angle += vel * dt;
        vel *= 0.95;
        turntable.style.transform = `rotate(${angle}rad)`;
        if (Math.abs(vel) > 0.0001) anim = requestAnimationFrame(inert);
      }
      anim = requestAnimationFrame(inert);
    });
    turntable.addEventListener('click', () => {
      if (audio.paused) { audio.play(); spin(); }
      else { audio.pause(); cancelAnimationFrame(anim); }
    });
    function spin() {
      vel = 2; lastT = performance.now();
      (function go() {
        const now = performance.now();
        const dt = (now - lastT) / 1000;
        lastT = now;
        angle += vel * dt;
        turntable.style.transform = `rotate(${angle}rad)`;
        anim = requestAnimationFrame(go);
      })();
    }

    // Image-based trunk control
    const wrap = document.getElementById('pitchWrapper');
    const topA = document.getElementById('anchorTop');
    const bottomA = document.getElementById('anchorBottom');
    const trunkImg = document.getElementById('trunk');

    let active = false;
    let startMouseX = 0, startMouseY = 0;
    let startVX = 0, startVY = 50;
    let vx = 0, vy = 50;

    // LFO
    let lfoFreq = 1, lfoDepth = 0.1, lfoPhase = 0, lastLfo = performance.now();
    function lfoLoop() {
      const now = performance.now();
      const dt = (now - lastLfo) / 1000;
      lastLfo = now;
      lfoPhase += 2 * Math.PI * lfoFreq * dt;
      const val = Math.sin(lfoPhase);
      audio.playbackRate = (vy / 50) + val * lfoDepth;
      requestAnimationFrame(lfoLoop);
    }
    lfoLoop();

    function updateTrunk() {
      const dx = vx;
      const dy = vy;
      const len = Math.hypot(dx, dy);
      // Rotate so vertical up (0,1) aligns to vector (dx, dy)
      const ang = Math.atan2(dx, dy);
      const scale = len / 50;
      trunkImg.style.transform = `rotate(${ang}rad) scaleY(${scale})`;
      topA.style.bottom = `${vy}px`;
      topA.style.left = `calc(50% - 10px + ${dx}px)`;
    }
    updateTrunk();

    topA.addEventListener('mousedown', e => {
      e.preventDefault(); active = true;
      startMouseX = e.clientX; startMouseY = e.clientY;
      startVX = vx; startVY = vy;
      wrap.style.cursor = 'grabbing';
    });
    document.addEventListener('mousemove', e => {
      if (!active) return;
      vx = startVX + (e.clientX - startMouseX);
      vy = startVY + (startMouseY - e.clientY);
      lfoFreq = 1 + vx / 50;
      updateTrunk();
    });
    document.addEventListener('mouseup', () => {
      if (active) {
        active = false;
        wrap.style.cursor = 'default';
      }
    });
  </script>
</body>
</html>
